{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Estilo de los botones dentro del modal */
    .modal-close, .modal-prev, .modal-next, .modal-download, .modal-delete {
        position: absolute;
        color: white;
        font-size: 24px;
        font-weight: bold;
        background: none;
        border: none;
        cursor: pointer;
    }

    /* Estilo para el bot√≥n de cerrar (X) */
    .modal-close {
        top: 20px;
        right: 30px;
    }

    /* Estilo para las flechas de cambio de foto */
    .modal-prev, .modal-next {
        top: 50%;
        transform: translateY(-50%);
        font-size: 30px;
    }

    .modal-prev {
        left: 30px;
    }

    .modal-next {
        right: 30px;
    }

    /* Estilo para el bot√≥n de descarga */
    .modal-download {
        bottom: 30px;
        left: 30px;
        font-size: 20px;
        color: white;
    }

    /* Estilo para el bot√≥n de eliminar (papelera) */
    .modal-delete {
        bottom: 30px;
        right: 30px;
        font-size: 20px;
        color: white;
    }

    /* Aseg√∫rate de que los botones est√©n siempre visibles dentro del modal */
    .modal-content {
        position: relative;
        max-width: 80%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .modal-content img {
        max-width: 100%;
        max-height: 60vh;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="centered">
    <a href="{% url 'subir_foto' %}" class="upload-main-button">Subir Foto</a>
</div>

<div class="gallery-container">
    <div class="gallery-grid">
        {% for foto in fotos %}
            <img src="{{ foto.imagen.url }}" alt="Foto" onclick="openModal({{ forloop.counter0 }})">
        {% endfor %}
    </div>
</div>

<!-- Modal -->
<div id="fotoModal" class="modal">
    <span class="modal-close" onclick="closeModal()">‚úñ</span>
    <button class="modal-prev" onclick="changeFoto(-1)">‚ùÆ</button>
    <button class="modal-next" onclick="changeFoto(1)">‚ùØ</button>
    <div class="modal-content">
        <img id="modalImagen" src="" alt="Foto">
        <!-- Bot√≥n de descarga siempre visible -->
        <a id="modalDownload" class="modal-download" href="" download>‚¨á Descargar</a>
        <!-- Bot√≥n de eliminar siempre visible -->
        <button class="modal-delete" onclick="mostrarClave()">üóë</button>

        <div class="modal-comentarios" id="modalComentarios"></div>
        <form id="modalForm" class="modal-form" method="post">
            {% csrf_token %}
            <textarea name="comentario" placeholder="Escribe tu comentario aqu√≠..."></textarea>
            <button type="submit">Comentar</button>
        </form>
    </div>
</div>

<!-- Formulario oculto para eliminar -->
<form id="deleteForm" method="post" style="display:none;">
    {% csrf_token %}
    <input type="password" name="clave" id="claveInput" placeholder="Introduce clave para borrar (pilusa)">
</form>

<script>
    const fotos = [{% for foto in fotos %}
        {
            id: {{ foto.id }},
            url: "{{ foto.imagen.url }}",
            comentarios: [{% for comentario in foto.comentarios.all %}{ texto: "{{ comentario.texto|escapejs }}", fecha: "{{ comentario.fecha|date:'d/m/Y H:i' }}" },{% endfor %}]
        },
    {% endfor %}];

    let currentIndex = 0;

    function openModal(index) {
        currentIndex = index;
        const foto = fotos[currentIndex];
        document.getElementById("modalImagen").src = foto.url;
        document.getElementById("modalDownload").href = foto.url;
        document.getElementById("modalComentarios").innerHTML = foto.comentarios.map(
            c => `<p><strong>${c.fecha}</strong>: ${c.texto}</p>`
        ).join('');
        document.getElementById("modalForm").action = "/fotos/comentar/" + foto.id + "/";
        document.getElementById("fotoModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("fotoModal").style.display = "none";
    }

    function changeFoto(step) {
        currentIndex = (currentIndex + step + fotos.length) % fotos.length;
        openModal(currentIndex);
    }

    function mostrarClave() {
        const clave = prompt("Introduce la clave para borrar la foto:");
        if (clave !== null) {
            const form = document.getElementById("deleteForm");
            form.action = "/fotos/borrar_foto/" + fotos[currentIndex].id + "/";
            document.getElementById("claveInput").value = clave;
            form.submit();
            // Elimina la foto del DOM si es exitosa
            document.querySelector(`[src="${fotos[currentIndex].url}"]`).remove();
            closeModal();
        }
    }
</script>
{% endblock %}
